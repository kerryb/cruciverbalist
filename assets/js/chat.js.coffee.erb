window.setupChat = (conversationID) ->
  viewModel = new ChatViewModel
  ko.applyBindings viewModel
  setupPusher "chat-#{conversationID}"
  loadMessages viewModel, "/conversation/#{conversationID}/messages"
  $("#new-message").focus()

class Message
  constructor: (@username, @content, @type) ->

class ChatViewModel
  messages: ko.observableArray()

  newMessage: ko.observable ""
  keyPressed: (data, event) =>
    return true unless event.charCode is 13
    unless @newMessage() is ""
      @messages.push new Message("kerry", @newMessage(), "message")
    $("#conversation").scrollTop $("#conversation").height()
    @newMessage ""

setupPusher = (channel) ->
  pusher = new Pusher "<%= Pusher.key %>"
  channel = pusher.subscribe channel
  channel.bind "new-chat-message", (data) ->
    appview.addMessage new Message(JSON.parse(data.message))

loadMessages = (viewModel, url) ->
  $.getJSON url, (data) ->
    for message in data
      viewModel.messages.push new Message(message.username, message.content, message.type)
