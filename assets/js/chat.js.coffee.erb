window.setupChat = ->
  setupKnockout()
  setupPusher()

conversationId = $("#conversation").attr("data-id")

class Message
  constructor: (params) ->
    @username = ko.observable params.username
    @content = ko.observable params.content
    @type = ko.observable params.type

class ChatViewModel
  messages: ko.observableArray [
    new Message(username: "fred", content: "hello", type: "message"),
    new Message(username: "bob", content: "waves", type: "action")
  ]

  newMessage: ko.observable ""
  keyPressed: (data, event) =>
    return true unless event.charCode is 13
    unless @newMessage() is ""
      @messages.push new Message(username: "kerry", content: @newMessage(), type: "message")
    @newMessage ""

setupKnockout = ->
  ko.applyBindings(new ChatViewModel)

setupPusher = ->
  pusher = new Pusher "<%= Pusher.key %>"
  channel = pusher.subscribe "chat-#{conversationId}"
  channel.bind "new-chat-message", (data) ->
    appview.addMessage new Message(JSON.parse(data.message))


# url: "/conversation/#{conversationId}/messages"
# setTimeout (->
#   conversation_list.scrollTop(conversation_list.attr("scrollHeight") - conversation_list.height())
# ), 100
