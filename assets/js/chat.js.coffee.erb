window.setupChat = ->
  setupKnockout()
  setupPusher()

conversationId = $("#conversation").attr("data-id")

class Message
  constructor: (@username, @content, @type) ->

class ChatViewModel
  messages: ko.observableArray [
    new Message("fred", "hello", "message"),
    new Message("bob", "waves", "action")
  ]

  newMessage: ko.observable ""
  keyPressed: (data, event) =>
    return true unless event.charCode is 13
    unless @newMessage() is ""
      @messages.push new Message("kerry", @newMessage(), "message")
    conversationList = $("#conversation")
    conversationList.scrollTop(conversationList.height())
    @newMessage ""

setupKnockout = ->
  ko.applyBindings(new ChatViewModel)

setupPusher = ->
  pusher = new Pusher "<%= Pusher.key %>"
  channel = pusher.subscribe "chat-#{conversationId}"
  channel.bind "new-chat-message", (data) ->
    appview.addMessage new Message(JSON.parse(data.message))


# url: "/conversation/#{conversationId}/messages"
# setTimeout (->
#   conversation_list.scrollTop(conversation_list.attr("scrollHeight") - conversation_list.height())
# ), 100
